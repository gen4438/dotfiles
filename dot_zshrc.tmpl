# Zsh configuration
# Managed by chezmoi - see dot_zshrc.tmpl

# Enable Powerlevel10k instant prompt. Should stay close to the top of ~/.zshrc.
if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi

# Plugin management
{{- if eq .chezmoi.os "linux" }}
# Linux - check common zplug locations
if [[ -f /usr/share/zplug/init.zsh ]]; then
    source /usr/share/zplug/init.zsh
elif [[ -f ~/.zplug/init.zsh ]]; then
    source ~/.zplug/init.zsh
fi
{{- else if eq .chezmoi.os "darwin" }}
# macOS - check brew zplug location
if [[ -f /opt/homebrew/opt/zplug/init.zsh ]]; then
    source /opt/homebrew/opt/zplug/init.zsh
elif [[ -f /usr/local/opt/zplug/init.zsh ]]; then
    source /usr/local/opt/zplug/init.zsh
elif [[ -f /opt/homebrew/share/zplug/init.zsh ]]; then
    source /opt/homebrew/share/zplug/init.zsh
elif [[ -f /usr/local/share/zplug/init.zsh ]]; then
    source /usr/local/share/zplug/init.zsh
elif [[ -f ~/.zplug/init.zsh ]]; then
    source ~/.zplug/init.zsh
fi
{{- end }}

# Load zplug plugins if available
if command -v zplug &> /dev/null; then
    # Use modern zstyle instead of deprecated ZPLUG_SHALLOW
    zstyle ':zplug:tag' depth 1
    # oh-my-zsh plugins
    zplug "lib/completion", from:oh-my-zsh
    zplug "lib/directories", from:oh-my-zsh
    zplug "lib/functions", from:oh-my-zsh
    zplug "lib/history", from:oh-my-zsh
    zplug "plugins/git", from:oh-my-zsh
    zplug "plugins/dotenv", from:oh-my-zsh
    zplug "plugins/poetry", from:oh-my-zsh
    zplug "plugins/npm", from:oh-my-zsh
    zplug "plugins/kubectl", from:oh-my-zsh
    zplug "plugins/gh", from:oh-my-zsh
    zplug "plugins/vi-mode", from:oh-my-zsh

    # Theme
    zplug "sindresorhus/pure", use:pure.zsh, from:github, as:theme

    # Other plugins
    zplug "mafredri/zsh-async", from:github
    zplug "zsh-users/zsh-history-substring-search", defer:2
    zplug "changyuheng/fz", defer:1
    zplug "rupa/z", use:z.sh
    zplug "greymd/tmux-xpanes"
    zplug "qoomon/zsh-lazyload"

    # Install plugins if there are plugins that have not been installed
    if ! zplug check --verbose; then
        printf "Install? [y/N]: "
        if read -q; then
            echo; zplug install
        fi
    fi

    # Load plugins
    zplug load
fi

# Completion
fpath+=~/.zfunc
autoload -Uz compinit && compinit -C

# Load common shell configuration (shared with bash)
# This includes modular loading of aliases, functions, completions, and keybindings
{{ template "shell_common.tmpl" . }}

# Zsh-specific settings
setopt AUTO_CD              # Change directory by typing directory name
setopt AUTO_PUSHD           # Push directories to stack
setopt PUSHD_IGNORE_DUPS    # Don't push duplicate directories
setopt EXTENDED_HISTORY     # Write the history file in the ':start:elapsed;command' format
setopt SHARE_HISTORY        # Share history between all sessions
setopt HIST_REDUCE_BLANKS   # Remove superfluous blanks from each command line
setopt HIST_IGNORE_ALL_DUPS # Delete an old recorded event if a new event is a duplicate
setopt HIST_SAVE_NO_DUPS    # Don't write a duplicate event to the history file
setopt HIST_VERIFY          # Don't execute immediately upon history expansion
setopt APPEND_HISTORY       # Append to history file
setopt INC_APPEND_HISTORY   # Write to the history file immediately, not when the shell exits
setopt NO_BEEP              # Don't beep on error
setopt CORRECT              # Correct commands
setopt CORRECT_ALL          # Correct all arguments
setopt COMPLETE_IN_WORD     # Complete from both ends of a word
setopt ALWAYS_TO_END        # Move cursor to the end of a completed word
setopt PATH_DIRS            # Perform path search even on command names with slashes
setopt AUTO_MENU            # Show completion menu on a successive tab press
setopt AUTO_LIST            # Automatically list choices on ambiguous completion
setopt AUTO_PARAM_SLASH     # If completed parameter is a directory, add a trailing slash

# Key bindings
bindkey -e  # Use emacs key bindings

# History search
bindkey '^[[A' history-substring-search-up
bindkey '^[[B' history-substring-search-down
bindkey '^P' history-substring-search-up
bindkey '^N' history-substring-search-down

# Zsh-specific aliases
alias reload='source ~/.zshrc'
alias zshconfig='${EDITOR:-vim} ~/.zshrc'

# fzf integration for zsh
[ -f ~/.fzf.zsh ] && source ~/.fzf.zsh

# Load local zsh configuration if exists
if [ -f "$HOME/.zshrc_local" ]; then
    source "$HOME/.zshrc_local"
fi

# To customize prompt, run `p10k configure` or edit ~/.p10k.zsh.
[[ ! -f ~/.p10k.zsh ]] || source ~/.p10k.zsh