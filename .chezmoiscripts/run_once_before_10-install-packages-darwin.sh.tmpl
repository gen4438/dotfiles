{{- if eq .chezmoi.os "darwin" -}}
{{ template "shebang-bash.tmpl" . }}
# Install essential packages for macOS development environment
# This script is refactored to use common libraries and external Brewfile

set -e

# Include common libraries
{{ template "lib-logging.sh.tmpl" . }}

log_info "Installing essential packages for macOS..."

# Install Homebrew if not present
if ! check_command brew; then
    log_running "Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

    # Add Homebrew to PATH for current session
    if [[ -f /opt/homebrew/bin/brew ]]; then
        # Apple Silicon
        eval "$(/opt/homebrew/bin/brew shellenv)"
        log_info "Homebrew installed (Apple Silicon)"
    elif [[ -f /usr/local/bin/brew ]]; then
        # Intel
        eval "$(/usr/local/bin/brew shellenv)"
        log_info "Homebrew installed (Intel)"
    fi

    log_success "Homebrew installed successfully"
else
    log_success "Homebrew is already installed"
fi

# Update Homebrew
log_running "Updating Homebrew..."
if brew update; then
    log_success "Homebrew updated"
else
    log_warning "Failed to update Homebrew, continuing anyway..."
fi

# Install packages from Brewfile
BREWFILE="{{ .chezmoi.sourceDir }}/Brewfile"

if [[ -f "$BREWFILE" ]]; then
    log_step "Installing packages from Brewfile..."

    if brew bundle --file="$BREWFILE"; then
        log_success "Packages installed from Brewfile"
    else
        log_error "Failed to install packages from Brewfile"
        exit 1
    fi
else
    log_error "Brewfile not found at: $BREWFILE"
    exit 1
fi

# Install fzf key bindings and fuzzy completion
if check_command fzf; then
    log_step "Setting up fzf key bindings..."

    FZF_PREFIX=$(brew --prefix fzf 2>/dev/null || echo "/opt/homebrew/opt/fzf")

    if [[ -f "$FZF_PREFIX/install" ]]; then
        "$FZF_PREFIX/install" --all --no-update-rc
        log_success "fzf key bindings installed"
    else
        log_warning "fzf install script not found at $FZF_PREFIX"
    fi
fi

# Install oh-my-zsh
if [[ ! -d "$HOME/.oh-my-zsh" ]]; then
    log_running "Installing oh-my-zsh..."
    sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
    log_success "oh-my-zsh installed successfully"
else
    log_success "oh-my-zsh is already installed"
fi

log_success "Essential packages installed successfully"
{{- end }}
