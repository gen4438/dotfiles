{{- if eq .chezmoi.os "linux" -}}
{{- $distro := .chezmoi.osRelease.id -}}
{{- if not (eq $distro "termux") -}}
{{ template "shebang-bash.tmpl" . }}
# Install essential packages for Linux distributions
# This script is refactored to use common libraries and external package lists

set -e

# Include common libraries
{{ template "lib-logging.sh.tmpl" . }}
{{ template "lib-package-manager.sh.tmpl" . }}

log_info "Installing essential packages for {{ .chezmoi.osRelease.name }}..."

# Update package database
update_package_database

# Install common packages
log_step "Installing common Linux packages..."
install_packages_from_file "{{ .chezmoi.sourceDir }}/packages/linux-common.txt"

# Install distribution-specific packages
{{- if or (eq $distro "ubuntu") (eq $distro "debian") }}
log_step "Installing Ubuntu/Debian-specific packages..."
install_packages_from_file "{{ .chezmoi.sourceDir }}/packages/linux-ubuntu.txt"

# Install Neovim from PPA
log_running "Adding Neovim PPA..."
if sudo -E add-apt-repository ppa:neovim-ppa/unstable -y; then
    sudo -E apt update
    install_packages neovim
else
    log_warning "Failed to add Neovim PPA, trying to install from default repos..."
    install_packages neovim || log_warning "Neovim installation failed"
fi

# GitHub CLI
log_running "Installing GitHub CLI..."
if ! check_command gh; then
    curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | \
        sudo -E dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg && \
        sudo -E chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg && \
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | \
        sudo -E tee /etc/apt/sources.list.d/github-cli.list > /dev/null && \
        sudo -E apt update && \
        install_packages gh
else
    log_success "GitHub CLI is already installed"
fi

{{- else if or (eq $distro "almalinux") (eq $distro "rocky") (eq $distro "centos") (eq $distro "rhel") (eq $distro "fedora") }}
log_step "Installing RedHat-based distribution packages..."

# Enable EPEL repository for additional packages
{{- if not (eq $distro "fedora") }}
if ! is_package_installed epel-release; then
    log_running "Installing EPEL repository..."
    install_packages epel-release
fi
{{- end }}

install_packages_from_file "{{ .chezmoi.sourceDir }}/packages/linux-redhat.txt"

# Install Neovim
install_packages neovim

# GitHub CLI
log_running "Installing GitHub CLI..."
if ! check_command gh; then
    sudo -E dnf config-manager --add-repo https://cli.github.com/packages/rpm/gh-cli.repo
    install_packages gh
else
    log_success "GitHub CLI is already installed"
fi

{{- else if or (eq $distro "arch") (eq $distro "manjaro") }}
log_step "Installing Arch-based distribution packages..."
install_packages_from_file "{{ .chezmoi.sourceDir }}/packages/linux-arch.txt"

# Install Neovim and GitHub CLI
install_packages neovim github-cli

{{- else }}
log_warning "Unsupported distribution '{{ $distro }}'"
log_warning "Please install packages manually"
exit 0
{{- end }}

# Install Japanese fonts if GUI or X11 forwarding might be used
if [[ -n "$DISPLAY" || -n "$WAYLAND_DISPLAY" || -n "$XDG_SESSION_TYPE" ]]; then
    log_step "GUI support detected, installing Japanese fonts..."
    {{- if or (eq $distro "ubuntu") (eq $distro "debian") }}
    install_packages_from_file "{{ .chezmoi.sourceDir }}/packages/fonts-japanese-ubuntu.txt"
    {{- else if or (eq $distro "almalinux") (eq $distro "rocky") (eq $distro "centos") (eq $distro "rhel") (eq $distro "fedora") }}
    install_packages_from_file "{{ .chezmoi.sourceDir }}/packages/fonts-japanese-redhat.txt"
    {{- else if or (eq $distro "arch") (eq $distro "manjaro") }}
    install_packages_from_file "{{ .chezmoi.sourceDir }}/packages/fonts-japanese-arch.txt"
    {{- end }}
fi

# Install oh-my-zsh if not present
if [[ ! -d "$HOME/.oh-my-zsh" ]]; then
    log_running "Installing oh-my-zsh..."
    sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
    log_success "oh-my-zsh installed successfully"
else
    log_success "oh-my-zsh is already installed"
fi

log_success "Essential packages installed successfully"
{{- end }}
{{- end }}
