{{- if eq .chezmoi.os "windows" -}}
# Windows-specific system settings and PATH configuration
# This script is refactored to use common libraries

$ErrorActionPreference = "Stop"

# Include common libraries
{{ template "lib-logging.ps1.tmpl" . }}

Log-Info "Configuring Windows-specific settings..."

# Function to add directory to PATH
function Add-ToPath {
    param (
        [string]$NewPath
    )

    if (Test-Path $NewPath) {
        $currentPath = [System.Environment]::GetEnvironmentVariable('PATH', [System.EnvironmentVariableTarget]::User)
        $pathEntries = $currentPath -split ';' | Where-Object { $_ -ne '' }

        if ($NewPath -notin $pathEntries) {
            Log-Running "Adding $NewPath to user PATH"
            $newUserPath = ($pathEntries + $NewPath) -join ';'
            [System.Environment]::SetEnvironmentVariable('PATH', $newUserPath, [System.EnvironmentVariableTarget]::User)
            Log-Success "Added $NewPath to PATH"
        } else {
            Log-Success "$NewPath is already in PATH"
        }
    } else {
        Log-Info "Directory $NewPath does not exist yet, skipping"
    }
}

# Create and add user bin directories to PATH
$userBinPath = "$env:USERPROFILE\bin"
$localBinPath = "$env:USERPROFILE\.local\bin"

Log-Step "Setting up user bin directories..."

# Create directories if they don't exist
@($userBinPath, $localBinPath) | ForEach-Object {
    if (-not (Test-Path $_)) {
        try {
            New-Item -ItemType Directory -Path $_ -Force | Out-Null
            Log-Success "Created directory: $_"
        } catch {
            Log-Error "Failed to create directory ${_}: $($_.Exception.Message)"
        }
    } else {
        Log-Info "Directory already exists: $_"
    }
}

# Add to PATH
Add-ToPath $userBinPath
Add-ToPath $localBinPath

# Set DISPLAY environment variable for X11 forwarding
Log-Step "Setting up X11 forwarding..."
try {
    [System.Environment]::SetEnvironmentVariable('DISPLAY', 'localhost:0', [System.EnvironmentVariableTarget]::User)
    Log-Success "Set DISPLAY=localhost:0 for user environment"
} catch {
    Log-Warning "Failed to set DISPLAY environment variable: $_"
}

# Apply keyboard repeat rate settings
$regFile = "{{ .chezmoi.sourceDir }}\scripts\windows\key_speed.reg"

if (Test-Path $regFile) {
    Log-Step "Applying keyboard repeat rate settings..."
    try {
        Start-Process -FilePath "reg" -ArgumentList "import", "`"$regFile`"" -Wait -NoNewWindow
        Log-Success "Keyboard settings applied"
    } catch {
        Log-Warning "Failed to apply keyboard settings: $_"
    }
} else {
    Log-Info "Registry file not found: $regFile (skipping keyboard settings)"
}

# Create PowerShell profile directory if it doesn't exist
Log-Step "Setting up PowerShell profile directory..."
$profileDir = Split-Path $PROFILE -Parent

if (-not (Test-Path $profileDir)) {
    try {
        New-Item -ItemType Directory -Path $profileDir -Force | Out-Null
        Log-Success "Created PowerShell profile directory"
    } catch {
        Log-Error "Failed to create PowerShell profile directory: $_"
    }
} else {
    Log-Success "PowerShell profile directory already exists"
}

Log-Success "Windows settings configuration completed"
Log-Info "Note: You may need to restart your shell or log out/in for PATH changes to take effect"
{{- end }}
