{{ template "shebang-bash.tmpl" . }}
# Update Neovim Python and Node.js packages
# This script runs when its content changes to update Neovim dependencies

set -e

echo "ðŸ”„ Updating Neovim environment packages..."

# Update Python packages for Neovim
{{- if ne .chezmoi.os "android" }}
if command -v pyenv >/dev/null 2>&1; then
    echo "ðŸ Updating Python packages for Neovim..."
    
    # Initialize pyenv
    export PYENV_ROOT="$HOME/.pyenv"
    export PATH="$PYENV_ROOT/bin:$PATH"
    eval "$(pyenv init -)"
    
    # Check if neovim3 virtualenv exists
    if pyenv versions | grep -q "neovim3"; then
        # Update packages in Neovim virtual environment
        pyenv activate neovim3
        pip install --upgrade pip
        pip install --upgrade neovim coverage pynvim
        echo "âœ… Neovim Python packages updated"
        pyenv deactivate
    else
        echo "âš ï¸  Neovim Python environment not found. Run initial setup first."
    fi
elif command -v pipx >/dev/null 2>&1; then
    # Fallback to pipx for better isolation
    echo "âš ï¸  Using pipx to update packages..."
    pipx upgrade pynvim || pipx install pynvim
    pipx upgrade neovim || pipx install neovim
elif command -v python3 >/dev/null 2>&1; then
    # Last resort: system pip
    echo "âš ï¸  Using system pip to update packages (consider installing pipx)..."
    python3 -m pip install --user --upgrade neovim pynvim
fi
{{- else }}
# Android/Termux: Use system packages
echo "ðŸ Android/Termux: Updating Python packages globally..."
if command -v pipx >/dev/null 2>&1; then
    pipx upgrade pynvim || pipx install pynvim
    pipx upgrade neovim || pipx install neovim
    echo "âœ… Neovim Python packages updated"
elif command -v python3 >/dev/null 2>&1; then
    python3 -m pip install --user --upgrade neovim pynvim
    echo "âœ… Neovim Python packages updated"
fi
{{- end }}

# Update Node.js packages for Neovim
{{- if ne .chezmoi.os "android" }}
if [[ -d "$HOME/.nvm" ]]; then
    echo "ðŸ“¦ Updating Node.js packages for Neovim..."
    
    # Initialize nvm
    export NVM_DIR="$HOME/.nvm"
    [[ -s "$NVM_DIR/nvm.sh" ]] && \. "$NVM_DIR/nvm.sh"
    
    if command -v nvm >/dev/null 2>&1; then
        # Use LTS version
        nvm use --lts
        
        # Update Neovim Node.js package
        npm update -g neovim
        echo "âœ… Neovim Node.js package updated"
    fi
elif command -v npm >/dev/null 2>&1; then
    # Fallback to system npm
    echo "âš ï¸  Using system npm to update packages..."
    npm update -g neovim
fi
{{- else }}
# Android/Termux: Use system npm
echo "ðŸ“¦ Android/Termux: Updating Node.js packages globally..."
if command -v npm >/dev/null 2>&1; then
    npm update -g neovim
    echo "âœ… Neovim Node.js package updated"
fi
{{- end }}

echo "âœ… Neovim environment packages updated successfully!"

# Hash to trigger updates when script changes
# Script hash: {{ include ".chezmoiscripts/run_onchange_35-update-neovim-environment.sh.tmpl" | sha256sum }}