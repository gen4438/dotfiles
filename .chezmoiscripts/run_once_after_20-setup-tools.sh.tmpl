{{ template "shebang-bash.tmpl" . }}
# Setup development tools after package installation
# This script is refactored to use common libraries
# script hash: {{ include ".chezmoiscripts/run_once_after_20-setup-tools.sh.tmpl" | sha256sum }}

set -e

# Include common libraries
{{ template "lib-logging.sh.tmpl" . }}
{{ template "lib-pyenv.sh.tmpl" . }}
{{ template "lib-nvm.sh.tmpl" . }}

log_info "Setting up development tools..."

# Setup fzf
if check_directory "$HOME/.fzf"; then
    log_step "Checking fzf setup..."
    # Check if fzf is already properly installed
    if [[ ! -f "$HOME/.fzf.bash" ]] || [[ ! -f "$HOME/.fzf.zsh" ]]; then
        log_running "Setting up fzf..."
        cd "$HOME/.fzf"
        ./install --all --no-update-rc
        log_success "fzf setup completed"
    else
        log_success "fzf already configured"
    fi
fi

# Setup pyenv and install Python
{{- if ne .chezmoi.os "windows" }}
log_step "Setting up pyenv..."

if pyenv_ensure_latest; then
    log_success "pyenv setup completed"
else
    log_warning "Failed to setup pyenv"
    log_info "pyenv may not be installed yet. Install it with:"
    {{- if eq .chezmoi.os "darwin" }}
    log_info "  brew install pyenv pyenv-virtualenv"
    {{- else if eq .chezmoi.os "linux" }}
    log_info "  chezmoi will install pyenv via externals to ~/.pyenv"
    log_info "  Run 'chezmoi apply' again after system packages are installed"
    {{- end }}
fi
{{- end }}

# Setup nvm and install Node.js
if check_directory "$HOME/.nvm"; then
    log_step "Setting up nvm..."

    if nvm_ensure_lts; then
        log_success "nvm setup completed"
    else
        log_error "Failed to setup nvm"
    fi
fi

# Setup zplug and install plugins (only for zsh users)
{{- $shells := fromJson (includeTemplate "shell-detection.tmpl" .) }}
{{- if $shells.uses_zsh }}
log_step "Setting up zplug plugins..."

# Platform-appropriate zplug detection
{{- if eq .chezmoi.os "darwin" }}
# macOS - check Homebrew locations first, then local (chezmoi external backup)
ZPLUG_HOME=""
for zplug_path in \
    "/opt/homebrew/opt/zplug" \
    "/usr/local/opt/zplug" \
    "/opt/homebrew/share/zplug" \
    "/usr/local/share/zplug" \
    "$HOME/.zplug"; do
    if [[ -f "$zplug_path/init.zsh" ]]; then
        export ZPLUG_HOME="$zplug_path"
        break
    fi
done
{{- else }}
# Linux/Android/other - chezmoi external manages zplug at ~/.zplug
if [[ -f "$HOME/.zplug/init.zsh" ]]; then
    export ZPLUG_HOME="$HOME/.zplug"
fi
{{- end }}

if [[ -n "$ZPLUG_HOME" && -f "$ZPLUG_HOME/init.zsh" ]]; then
    log_info "Checking zplug plugins..."

    # zplug requires zsh, so we run it in a zsh subshell
    if check_command zsh; then
        # Check if plugins are already installed by checking for a key plugin directory
        ZPLUG_REPOS_DIR="$ZPLUG_HOME/repos"
        if [[ ! -d "$ZPLUG_REPOS_DIR/sindresorhus/pure" ]] || [[ ! -d "$ZPLUG_REPOS_DIR/robbyrussell/oh-my-zsh" ]]; then
            log_running "Installing zplug plugins..."
            zsh -c "
                export ZPLUG_HOME='$ZPLUG_HOME'
                source '$ZPLUG_HOME/init.zsh'
                zstyle ':zplug:tag' depth 1

                # Define plugins (matching .zshrc.tmpl)
                zplug 'lib/completion', from:oh-my-zsh
                zplug 'lib/directories', from:oh-my-zsh
                zplug 'lib/functions', from:oh-my-zsh
                zplug 'lib/history', from:oh-my-zsh
                zplug 'plugins/git', from:oh-my-zsh
                zplug 'plugins/dotenv', from:oh-my-zsh
                zplug 'plugins/poetry', from:oh-my-zsh
                zplug 'plugins/npm', from:oh-my-zsh
                zplug 'plugins/kubectl', from:oh-my-zsh
                zplug 'plugins/gh', from:oh-my-zsh
                zplug 'plugins/vi-mode', from:oh-my-zsh
                zplug 'sindresorhus/pure', use:pure.zsh, from:github, as:theme
                zplug 'mafredri/zsh-async', from:github
                zplug 'zsh-users/zsh-history-substring-search', defer:2
                zplug 'changyuheng/fz', defer:1
                zplug 'rupa/z', use:z.sh
                zplug 'greymd/tmux-xpanes'
                zplug 'qoomon/zsh-lazyload'

                # Install plugins (ignore \"no packages to install\" error)
                zplug install || [[ \$? -eq 1 && \$(zplug list | wc -l) -gt 0 ]]
            "
            log_success "zplug plugins installed"
        else
            log_success "zplug plugins already installed"
        fi
    else
        log_warning "zsh not available, skipping zplug plugin installation"
    fi
else
    log_warning "zplug not found, skipping plugin installation"
fi
{{- else }}
log_info "zsh not detected, skipping zplug plugin installation"
{{- end }}

# Setup tmux plugin manager
if check_directory "$HOME/.tmux/plugins/tpm"; then
    log_step "Checking tmux plugin manager..."

    # Install tmux plugins if tmux is available
    if check_command tmux; then
        # Check if plugins are already installed by looking for common plugin directories
        if [[ ! -d "$HOME/.tmux/plugins/tmux-sensible" ]] && [[ ! -d "$HOME/.tmux/plugins/tmux-yank" ]]; then
            log_running "Installing tmux plugins..."
            # Set TMUX_PLUGIN_MANAGER_PATH for the install script
            export TMUX_PLUGIN_MANAGER_PATH="$HOME/.tmux/plugins"
            # Run TPM install script
            "$HOME/.tmux/plugins/tpm/bin/install_plugins"
            log_success "tmux plugins installed"
        else
            log_success "tmux plugins already installed"
        fi
    fi
fi

{{- if eq .chezmoi.os "darwin" }}
# macOS specific setup
log_step "Setting up macOS specific tools..."

# Additional macOS-specific tools can be added here
{{- end }}

{{- if eq .chezmoi.os "linux" }}
# Linux specific setup
log_step "Setting up Linux specific tools..."

# Setup direnv if available
if check_command direnv; then
    log_success "direnv is available"
fi
{{- else if eq .chezmoi.os "android" }}
# Android/Termux specific setup
log_step "Setting up Android/Termux specific tools..."

# Termux-specific configurations can be added here
log_success "Termux environment detected"
{{- end }}

{{- if eq .chezmoi.os "windows" }}
# Windows specific setup (PowerShell)
log_step "Setting up Windows specific tools..."

# This will be handled in PowerShell scripts
{{- end }}

# Setup gvm (Go Version Manager)
{{- if ne .chezmoi.os "windows" }}
log_step "Setting up gvm..."
if [[ -s "$HOME/.gvm/scripts/gvm" ]]; then
    log_success "gvm is already installed"
else
    log_running "Installing gvm..."
    if bash < <(curl -s -S -L https://raw.githubusercontent.com/moovweb/gvm/master/binscripts/gvm-installer) 2>&1; then
        log_success "gvm installed successfully"
    else
        log_warning "Failed to install gvm"
    fi
fi
{{- end }}

# Setup uv (Python package manager)
{{- if ne .chezmoi.os "windows" }}
log_step "Setting up uv..."
if check_command uv; then
    log_success "uv is already installed"
else
    log_running "Installing uv..."
    if curl -LsSf https://astral.sh/uv/install.sh | sh; then
        log_success "uv installed successfully"
    else
        log_warning "Failed to install uv"
    fi
fi
{{- end }}

log_success "Development tools setup completed"
