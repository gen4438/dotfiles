{{ template "shebang-bash.tmpl" . }}
# Setup Neovim Python and Node.js environments
# This script runs once to set up Neovim-specific dependencies
# This script is refactored to use common libraries
# script hash: {{ include ".chezmoiscripts/run_once_after_25-setup-neovim-environment.sh.tmpl" | sha256sum }}

set -e

# Include common libraries
{{ template "lib-logging.sh.tmpl" . }}
{{ template "lib-pyenv.sh.tmpl" . }}
{{ template "lib-nvm.sh.tmpl" . }}

log_info "Setting up Neovim environment..."

# Setup Python environment for Neovim
{{- if ne .chezmoi.os "windows" }}
log_step "Setting up Python environment for Neovim..."

# Try to initialize pyenv
if pyenv_init; then
        # Get latest Python version
        latest_python=$(pyenv_get_latest_version)

        if [[ -n "$latest_python" ]]; then
            # Ensure Python is installed
            if ! pyenv_is_version_installed "$latest_python"; then
                pyenv_install_version "$latest_python"
            fi

            # Create virtual environment for Neovim
            if pyenv_create_virtualenv "$latest_python" "neovim3"; then
                # Install Neovim Python packages
                if pyenv_venv_install_packages "neovim3" neovim coverage pynvim; then
                    python_path=$(pyenv which python)
                    log_success "Neovim Python environment created at: $python_path"
                else
                    log_error "Failed to install Python packages for Neovim"
                fi
            else
                log_error "Failed to create Python virtual environment for Neovim"
            fi
        else
            log_error "Could not determine latest Python version"
        fi
else
    log_warning "Failed to initialize pyenv"
fi

# Fallback to system Python if pyenv is not available
if ! check_command pyenv && check_command python3; then
    log_warning "pyenv not found, creating venv for Neovim..."

    # Create Neovim-specific venv
    if python3 -m venv ~/.local/share/nvim-venv; then
        # Install Neovim Python packages in venv
        ~/.local/share/nvim-venv/bin/pip install --upgrade pip
        ~/.local/share/nvim-venv/bin/pip install pynvim neovim

        log_success "Neovim Python environment created at ~/.local/share/nvim-venv"
    else
        log_error "Failed to create Python venv for Neovim"
    fi
fi
{{- end }}

# Setup Node.js environment for Neovim
if check_directory "$HOME/.nvm"; then
    log_step "Setting up Node.js environment for Neovim..."

    if nvm_init; then
        # Use LTS version
        if nvm_use_lts; then
            # Check if neovim package is already installed
            if ! nvm_is_global_package_installed neovim; then
                log_running "Installing Node.js packages for Neovim..."
                if nvm_install_global_packages neovim{{ if ne .chezmoi.os "linux" }} tree-sitter-cli{{ end }}; then
                    log_success "Neovim Node.js packages installed"
                else
                    log_error "Failed to install Neovim Node.js packages"
                fi
            else
                log_success "Neovim Node.js package already installed"
            fi
        else
            log_error "Failed to use LTS Node.js version"
        fi
    else
        log_error "Failed to initialize nvm"
    fi
elif check_command npm; then
    log_warning "nvm not found, using system npm..."
    # Check if neovim package is already installed
    if ! nvm_is_global_package_installed neovim; then
        log_running "Installing Node.js packages for Neovim..."
        npm install -g neovim
        log_success "Neovim Node.js package installed"
    else
        log_success "Neovim Node.js package already installed"
    fi
fi

{{ if eq .chezmoi.os "linux" -}}
# Install tree-sitter-cli via cargo on Linux
if check_command cargo; then
    if ! check_command tree-sitter; then
        log_running "Installing tree-sitter-cli via cargo..."
        if cargo install tree-sitter-cli; then
            log_success "tree-sitter-cli installed via cargo"
        else
            log_error "Failed to install tree-sitter-cli via cargo"
        fi
    else
        log_success "tree-sitter-cli already installed"
    fi
else
    log_warning "cargo not found, skipping tree-sitter-cli installation"
fi
{{- end }}

# Install Neovim providers health check
if check_command nvim; then
    log_step "Checking Neovim providers..."

    # Create a temporary vimrc to suppress warnings during health check
    TEMP_VIMRC=$(mktemp)
    echo "set noloadplugins" > "$TEMP_VIMRC"

    # Run health check for providers
    nvim -u "$TEMP_VIMRC" --headless "+checkhealth provider" "+qa" 2>&1 | grep -E "(python3|node|OK|WARNING|ERROR)" || true

    rm -f "$TEMP_VIMRC"
fi

log_success "Neovim environment setup completed"
