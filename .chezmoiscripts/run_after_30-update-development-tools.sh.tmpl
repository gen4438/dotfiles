{{ template "shebang-bash.tmpl" . }}
# Update development tools and runtimes
# This script runs on every chezmoi apply to keep tools up-to-date
# This script is refactored to use common libraries
# Git repositories are automatically updated by chezmoi external management

set -e

# Include common libraries
{{ template "lib-logging.sh.tmpl" . }}
{{ template "lib-pyenv.sh.tmpl" . }}
{{ template "lib-nvm.sh.tmpl" . }}

log_info "Updating development tools..."

# Note: External git repositories (.fzf, .pyenv, .nvm, etc.) are automatically
# updated by chezmoi external with refreshPeriod = "168h" (weekly)
log_info "External repositories are managed by chezmoi and updated weekly"

# Update pyenv and install latest Python
{{- if ne .chezmoi.os "android" }}
{{- if ne .chezmoi.os "windows" }}
log_step "Updating pyenv and Python..."

{{- if ne .chezmoi.os "darwin" }}
log_info "pyenv repositories are managed by chezmoi external with weekly updates"
{{- end }}

if pyenv_init; then
        # Get latest stable Python version
        latest_python=$(pyenv_get_latest_version)
        current_python=$(pyenv_get_global_version)

        # Install latest Python if not already installed
        if [[ -n "$latest_python" && "$latest_python" != "$current_python" ]]; then
            log_info "Latest Python: $latest_python (current: $current_python)"

            if pyenv_install_version "$latest_python"; then
                if pyenv_set_global_version "$latest_python"; then
                    log_success "Python updated to $latest_python"

                    # Update pip
                    pip install --upgrade pip
                else
                    log_error "Failed to set global Python version"
                fi
            else
                log_error "Failed to install Python $latest_python"
            fi
        else
            log_success "Python is up to date ($current_python)"
        fi

        # Always check and update neovim3 environment if needed
        if pyenv versions | grep -q "neovim3"; then
            # Check if neovim3 is using the latest Python
            if [[ -d "$PYENV_ROOT/versions/$latest_python/envs/neovim3" ]]; then
                log_success "neovim3 already using Python $latest_python"
            else
                log_running "Recreating neovim3 virtual environment with Python $latest_python..."

                # Delete old virtual environment
                pyenv uninstall -f neovim3

                # Create new virtual environment with latest Python
                if pyenv_create_virtualenv "$latest_python" "neovim3"; then
                    if pyenv_venv_install_packages "neovim3" neovim coverage pynvim; then
                        log_success "neovim3 environment recreated with Python $latest_python"
                    else
                        log_error "Failed to install packages in neovim3"
                    fi
                else
                    log_error "Failed to recreate neovim3 environment"
                fi
            fi
        else
            log_step "Creating neovim3 virtual environment with Python $latest_python..."
            if pyenv_create_virtualenv "$latest_python" "neovim3"; then
                if pyenv_venv_install_packages "neovim3" neovim coverage pynvim; then
                    log_success "neovim3 environment created with Python $latest_python"
                else
                    log_error "Failed to install packages in neovim3"
                fi
            else
                log_error "Failed to create neovim3 environment"
            fi
        fi
else
    log_warning "pyenv not available, skipping Python update"
fi
{{- end }}
{{- else }}
log_info "Android/Termux: Using system Python (pkg install python)"
log_info "Android/Termux: Using system Node.js (pkg install nodejs)"
log_step "Installing Neovim packages globally..."

# For Termux, install packages globally
if check_command pip; then
    pip install --upgrade --user pynvim neovim
    log_success "Python packages for Neovim installed"
fi

if check_command npm; then
    npm install -g neovim
    log_success "Node.js package for Neovim installed"
fi
{{- end }}

# Update nvm and Node.js
{{- if ne .chezmoi.os "android" }}
{{- if ne .chezmoi.os "windows" }}
log_step "Updating nvm and Node.js..."

{{- if ne .chezmoi.os "darwin" }}
log_info "nvm repositories are managed by chezmoi external with weekly updates"
{{- end }}

if nvm_init; then
        # Install/update to latest LTS if not using LTS
        current_version=$(nvm_get_default_version)

        if [[ -n "$current_version" ]]; then
            log_info "Current default Node.js: $current_version"

            # Check if there's a newer LTS version
            log_running "Checking for newer LTS version..."
            if nvm install --lts; then
                if nvm alias default lts/*; then
                    new_version=$(nvm_get_default_version)
                    if [[ "$new_version" != "$current_version" ]]; then
                        log_success "Node.js updated to $new_version"
                    else
                        log_success "Node.js is up to date ($current_version)"
                    fi
                fi
            else
                log_error "Failed to install/update Node.js LTS"
            fi
        else
            # No default version set, install LTS
            if nvm_ensure_lts; then
                log_success "Node.js LTS installed"
            else
                log_error "Failed to install Node.js LTS"
            fi
        fi

        # Ensure neovim package is installed
        if nvm_use_lts; then
            if ! nvm_is_global_package_installed neovim; then
                log_running "Installing Neovim Node.js package..."
                if nvm_install_global_packages neovim{{ if ne .chezmoi.os "linux" }} tree-sitter-cli{{ end }}; then
                    log_success "Neovim Node.js packages installed"
                else
                    log_error "Failed to install Neovim Node.js packages"
                fi
            else
                log_success "Neovim Node.js package is installed"
            fi
        fi
else
    log_warning "nvm not available, skipping Node.js update"
fi
{{- end }}
{{- end }}

# Update Rust toolchain
{{- if ne .chezmoi.os "windows" }}
log_step "Updating Rust toolchain..."
if check_command rustup; then
    if rustup update; then
        log_success "Rust toolchain updated"
    else
        log_warning "Failed to update Rust toolchain"
    fi
else
    log_warning "rustup not found, skipping Rust update"
fi
{{- end }}

log_success "Development tools update completed"
